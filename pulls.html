<!doctype html>
<html>
<head>
    <title>Performance platform pull requests</title>
    <link rel="stylesheet" href="https://assets.digital.cabinet-office.gov.uk/static/fonts.css">
    <link rel="stylesheet" href="pulls.css">
</head>
<body>
<ul id="pulls"></ul>
<p id="all-quiet">No open pull requests.</p>

<script src="http://code.jquery.com/jquery-2.0.0.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function() {

    $.ajaxSetup({
        headers: {
            'Authorization': 'token ' + getToken(document.location.search)
        }
    });
    var repos = [
        {
            user: 'alphagov',
            repo: 'backdrop'
        },
        {
            user: 'alphagov',
            repo: 'backdropsend'
        },
        {
            user: 'alphagov',
            repo: 'limelight'
        },
        {
            user: 'alphagov',
            repo: 'performance-platform'
        },
        {
            user: 'alphagov',
            repo: 'datainsight-frontend'
        },
        {
            user: 'alphagov',
            repo: 'datainsight-insidegov-collector'
        },
        {
            user: 'alphagov',
            repo: 'datainsight_collector'
        },
        {
            user: 'alphagov',
            repo: 'pp-puppet'
        },
        {
            user: 'alphagov',
            repo: 'puppet-backdrop'
        },
        {
            user: 'alphagov',
            repo: 'puppet-google_credentials'
        },
        {
            user: 'alphagov',
            repo: 'backdrop-ga-collector'
        },
        {
            user: 'alphagov',
            repo: 'backdrop-collector'
        },
        {
            user: 'alphagov',
            repo: 'backdrop-ga-realtime-collector'
        },
        {
            user: 'alphagov',
            repo: 'backdrop-google-spreadsheet-collector'
        },
        {
            user: 'alphagov',
            repo: 'backdrop-pingdom-collector'
        },
        {
            user: 'alphagov',
            repo: 'transactions-explorer'
        },
        {
            user: 'alphagov',
            repo: 'stageprompt'
        },
        {
            user: 'alphagov',
            repo: 'libretto'
        }
    ];

    function getToken(location) {
        return location.split("?token=")[1];
    }

    // See http://developer.github.com/v3/repos/statuses/
    // ala /repos/:owner/:repo/statuses/:ref
    // We use the base SHA
    function updateStatus(url,pull){
        $.ajax({
          url: url,
          success: function(data, textStatus, xhr) {
            if(data.length){
                var state = data[0].state;
                $('#status_'+pull.id).html('Build status: ' + state).addClass(state);
            } else {
                $('#status_'+pull.id).html('No build status')
            }
          },
          error: function(xhr, textStatus, errorThrown) {
            console.log(errorThrown);
          }
        });
    }

    function updateComments(pullId, url) {
        $.ajax({
            url: url,
            success: function (comments) {
                var suffix = "";
                if (comments.length == 0 || comments.length > 1) {
                    suffix = "s";
                }
                $("#" + pullId).find('.comments').html(" " + comments.length + " comment" + suffix);

                var thumbsup = comments.some(function(comment) {
                    var checkFor = [":+1:", ":thumbsup:"];
                    return checkFor.some(function(check) {
                        return comment.body.indexOf(check) != -1;
                    })
                });
                if (thumbsup) {
                    $("#" + pullId).addClass("thumbsup");
                }
            }
        });
    }

    function ageClass(seconds) {
        var hours = 3600;
        if (seconds > (6 * hours)) {
            return "age-old";
        } else if (seconds > (2 * hours)) {
            return "age-aging";
        } else {
            return "age-fresh";
        }
    }

    function secondsToTime(seconds) {
        var days    = Math.floor(seconds / 86400);
        var hours   = Math.floor((seconds - (days * 86400)) / 3600);
        var minutes = Math.floor((seconds - (days * 86400) - (hours * 3600)) / 60);

        if (hours   < 10) {hours   = "0"+hours;}
        if (minutes < 10) {minutes = "0"+minutes;}
        if (days == 1) {
            days = days + " day";
        } else if (days > 1) {
            days = days + " days";
        } else {
            days = "";
        }
        return days + ' ' + hours + 'h ' + minutes + 'm';
    }

    function startOfWorkingDay(date) {
        return moment(date).startOf('day').hours(9).minutes(30);
    }

    function endOfWorkingDay(date) {
        return moment(date).startOf('day').hours(17).minutes(30);
    }

    function workingTimeForDay(date, options) {
        options = options || {};
        date = moment(date).startOf('day');
        var isWeekend = date.day() === 0 || date.day() === 6;
        if (isWeekend) {
            return 0;
        }
        var min = Math.max(+(options.min || 0), +startOfWorkingDay(date));
        var max = Math.min(+(options.max || Infinity), +endOfWorkingDay(date));
        return Math.max((max - min) / 1000, 0);
    }

    function elapsedSeconds(created_at) {
        var now = moment();
        created_at = moment(created_at);

        var elapsed = 0;
        var date = moment(created_at).startOf('day');
        while (date < now) {
            elapsed += workingTimeForDay(date, {
                min: created_at,
                max: now
            });
            date.add(1, 'days');
        }

        return elapsed;
    }

    function parseTime(timeString) {
        var pattern = /(?:(\d+) days? )?(\d+)h (\d+)m/;
        var match = timeString.match(pattern);
        parts = match.slice(2, 4).map(function(part) { return parseInt(part); });

        var time = parts[0] * 3600 + parts[1] * 60;
        if (match[1] !== undefined) {
            time += parseInt(match[1]) * 86400;
        }
        return time;
    }

    var checkMaster = function(repoShas){
        var c = 0;

        window.reposShas = repoShas;
        $.each(window.repoShas, function(i, v) {
            console.log(i++);
            var url = [
                'https://api.github.com/repos/alphagov',
                v.repo,
                'statuses',
                v.sha
            ].join('/');

            $.ajax({
                url: url,
            })
            .done(function(data) {
                console.log("success",data,url,v.repo);
                if(data.length){
                    var top = data[0],
                        state = top.state,
                        id = v.repo+'_bignotice',
                        $notice = $('<h1></h1>'),
                        $sel = $('#'+id);

                    if($sel.length){
                        $sel.remove();
                    }

                    if(state === 'failure'){
                        $notice.html('<span class="repo">'+v.repo+'</span> '+top.description).attr('id',id).addClass('notice');
                        $('body').prepend($notice);
                    }


                }
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                // console.log("complete");
            });
        });

    };

    // GET /repos/:owner/:repo/commits
    var getBaseShas = function(){
        repoShas = [];
        $.each(repos, function(index, val) {
            var repo = val.repo,
                url = [
                    'https://api.github.com/repos',
                    val.user,
                    val.repo,
                    'commits'
                ].join('/');
            $.ajax({
                url: url,
            })
            .done(function(data) {

                if(typeof data !=="undefined"){
                    try{
                        var baseSha = data[0].sha,
                            obj = {'repo':repo,'sha':baseSha};
                        repoShas.push(obj);
                        if(repoShas.length==repos.length){
                            checkMaster(repoShas);
                            return false;
                        }
                    } catch (e){
                        console.log(e,'couldn\'t get commits data');
                        // checkMaster(repoShas);
                    }
                }
            })
            .fail(function() {
                // console.log("error");
            })
            .always(function() {
                // console.log("complete");
            });

        });
    }

    function update () {
        // potentially don't need to do this every time
        getBaseShas();

        $.each(repos, function(i, def) {
            var repo = def.repo,
                className = [def.user, def.repo].join('-'),
                baseUrl = 'https://api.github.com/repos',
                url = [
                    baseUrl,
                    def.user,
                    def.repo,
                    'pulls'
                ].join('/');

            $.ajax({
                url: url,
                success: function (pulls) {
                    $('#pulls').find('.' + className).remove();
                    $.each(pulls, function (j, pull) {
                        var secs = elapsedSeconds(pull.created_at);
                        var pullId = 'pull-' + pull.id;
                        var $el = $([
                            '<li id="', pullId, '" class="', className, ' ', ageClass(secs), '">',
                            '<img class="avatar" src="', pull.user.avatar_url, '" />',
                            '<h2>', repo, '</h2>',
                            '<p>',
                            '<a href="', pull.html_url, '">',
                            '<span class="username">',pull.user.login,'</span>',
                            ': ',
                            pull.title,
                            ' (#',
                            pull.number,
                            ')',
                            '</a>',
                            '<span class="comments"></span>',
                            '<div class="elapsed-time" data-created-at="',
                            pull.created_at,
                            '">',
                            secondsToTime(secs),
                            '</div>',
                            '<p id="status_'+pull.id+'" class="status"></p>',
                            '</p>',
                            '</li>'
                        ].join(''));

                        $('#pulls').append($el);
                        updateComments(pullId, pull.comments_url);
                        var statusUrl = [
                            baseUrl,
                            def.user,
                            def.repo,
                            'statuses',
                            pull.head.sha
                        ].join('/');
                        updateStatus(statusUrl,pull);
                    });

                    $fields = $('#pulls li').clone();

                    $('#pulls li').remove();

                    $('#pulls').append($fields.sort(function(left, right) {
                        var leftTime = +Date.parse($(left).find('.elapsed-time').data('created-at'));
                        var rightTime = +Date.parse($(right).find('.elapsed-time').data('created-at'));

                        return leftTime > rightTime ? 1 : (leftTime < rightTime ? -1 : 0);
                    }));

                    if ($('#pulls li').length) {
                        $('#all-quiet').hide();
                    } else {
                        $('#all-quiet').show();
                    }

                    updateTimes()
                }
            });
        });
    };

    function updateTimes() {
        $('#pulls li').each(function(i, el) {
            var timeEl = $(el).find(".elapsed-time");
            var elapsedTime = parseTime($(timeEl).html()) + 1;

            $(timeEl).html(secondsToTime(elapsedTime));
            $(el).removeClass("age-fresh age-aging age-old").addClass(ageClass(elapsedTime))
        });
    };

    update();
    setInterval(update, 30000);

    setInterval(updateTimes, 1000 * 60);
});

</script>
</body>
</html>
